; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/1 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/2 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/3 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/4 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/5 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/6 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/7 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/8 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, air, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/air/9 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/air/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/air/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/1 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/2 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/3 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/4 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/5 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/6 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/7 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/8 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, h2o, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=1/alpha_s=0.55/h2o/9 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/h2o/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/h2o/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac2, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac2/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac2/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.01)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.1)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 1, alpha_s = 0.55, pac4, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 1)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=1/alpha_s=0.55/pac4/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=1/alpha_s=0.55/pac4/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/1 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/2 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/3 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/4 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/5 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/6 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/7 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/8 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, air, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/air/9 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/air/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/air/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/1 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/2 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/3 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/4 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/5 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/6 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/7 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/8 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, h2o, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=2/alpha_s=0.55/h2o/9 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/h2o/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/h2o/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac2, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac2/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac2/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.02)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.2)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 2, alpha_s = 0.55, pac4, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 2)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=2/alpha_s=0.55/pac4/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=2/alpha_s=0.55/pac4/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/1 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/2 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/3 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/4 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/5 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/6 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/7 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/8 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, air, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/air/9 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y air
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-4
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/air/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/air/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/1 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/2 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/3 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/4 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/5 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/6 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/7 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/8 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, h2o, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.
;No cross model coefficients required.

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions compile "libudf" y y solutions/a=3/alpha_s=0.55/h2o/9 , ,
;No UDFs required ...compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y h2o
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
;No UDFs required ...compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 20000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

;No UDFs required ...compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/h2o/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/h2o/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac2, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

(rpsetvar 'cross/k 0.0109)
(rpsetvar 'cross/n 0.414)
(rpsetvar 'cross/mu_0 0.0721)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac2.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 40000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac2/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac2/9



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case1
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_1.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/1"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/1



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case2
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_2.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/2"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/2



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case3
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_1.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.05)
(rpsetvar 'x_min2 -0.04)
(rpsetvar 'x_line -0.045)
(rpsetvar 'x_max 0.05)
(rpsetvar 'y_max1 0.04)
(rpsetvar 'y_max2 0.03)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_3.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/3"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/3



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case4
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_4.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/4"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/4



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case5
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_5.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/5"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/5



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case6
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_2.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -0.5)
(rpsetvar 'x_min2 -0.4)
(rpsetvar 'x_line -0.45)
(rpsetvar 'x_max 0.5)
(rpsetvar 'y_max1 0.4)
(rpsetvar 'y_max2 0.3)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_6.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/6"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/6



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case7
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.0001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_7.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/7"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/7



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case8
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.001)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_8.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/8"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/8



; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------
; ---- NEW CASE STARTS HERE: a = 3, alpha_s = 0.55, pac4, case9
; --------------------------------------------------------------------------------------------
; --------------------------------------------------------------------------------------------


; --------------------------------------------------------------------------------------------
; Run granular cliff collapse
; --------------------------------------------------------------------------------------------

; 31.05.2018, alexander.busch@alumni.ntnu.no

; Reads predefined case files for respective spatial and particle scales and
; - patches the solid volume fraction representing the cliff at t = 0 s 
; - calculates quasi-steady-state solution for cliff collapse
; The solid bed interface is resolved with adaptive mesh refinement based on the solid volume fraction gradient.

; HOW TO
;	1 - Paste "/file/read-journal run_all.jou" in TUI to run simulations for defined spatial and particle scale
;	2 - Create hpc journal files via Matlab "modify_journal_file.m"



; --------------------------------------------------------------------------------------------
; Create case solution folder structure and read case file
; --------------------------------------------------------------------------------------------

/file/read-case case_3.cas OK

!if exist libudf rmdir /s /q libudf
!if exist "solution/reports" rmdir /s /q "solution/reports"
!if exist "solution/exports" rmdir /s /q "solution/exports"
!if exist "solution/monitors" rmdir /s /q "solution/monitors"
!if exist "solution/casefiles" rmdir /s /q "solution/casefiles"
!if exist "solution/cfd-post" rmdir /s /q "solution/cfd-post"
!mkdir "solution/reports"
!mkdir "solution/exports"
!mkdir "solution/monitors"
!mkdir "solution/casefiles"
!mkdir "solution/cfd-post"


; --------------------------------------------------------------------------------------------
; Parameters
; --------------------------------------------------------------------------------------------

(if (not (rp-var-object 'x_min1))	(rp-var-define 'x_min1 0 'real #f))
(if (not (rp-var-object 'x_min2))	(rp-var-define 'x_min2 0 'real #f))
(if (not (rp-var-object 'x_line))	(rp-var-define 'x_line 0 'real #f))
(if (not (rp-var-object 'x_max))	(rp-var-define 'x_max 0 'real #f))
(if (not (rp-var-object 'y_max1))	(rp-var-define 'y_max1 0 'real #f))
(if (not (rp-var-object 'y_max2))	(rp-var-define 'y_max2 0 'real #f))

(if (not (rp-var-object 'cross/rho))	(rp-var-define 'cross/rho 1000 'real #f))
(if (not (rp-var-object 'cross/k))		(rp-var-define 'cross/k 0.001002 'real #f))
(if (not (rp-var-object 'cross/n))		(rp-var-define 'cross/n 1 'real #f))
(if (not (rp-var-object 'cross/mu_0))	(rp-var-define 'cross/mu_0 0.0721 'real #f))
(if (not (rp-var-object 'cross/mu_inf))	(rp-var-define 'cross/mu_inf 0.001002 'real #f))

(rpsetvar 'x_min1 -5)
(rpsetvar 'x_min2 -4)
(rpsetvar 'x_line -4.5)
(rpsetvar 'x_max 5)
(rpsetvar 'y_max1 4)
(rpsetvar 'y_max2 3)

(rpsetvar 'cross/k 0.0261)
(rpsetvar 'cross/n 0.392)
(rpsetvar 'cross/mu_0 0.21)
(rpsetvar 'cross/mu_inf 0.00102)

(rpsetvar 'sand/d 0.01)
(rpsetvar 'sand/angle_intfric 55)
(rpsetvar 'sand/alpha_fric 0.50)
(rpsetvar 'sand/alpha_pack 0.635)
(rpsetvar 'sand/alpha_ini 0.55)


; --------------------------------------------------------------------------------------------
; UDF
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions compile "libudf" y y "rheology_pac4.c" , ,
/define/user-defined/compiled-functions load "libudf"
; Not needed as pac-specific .c files are used instead   /define/user-defined/function-hooks/adjust "pass_schemevariables_to_nodes::libudf" ""


; --------------------------------------------------------------------------------------------
; Change color scheme
; --------------------------------------------------------------------------------------------

/display/set/colors/color-scheme classic
/display/set/colors/background "white"
/display/set/colors/foreground "black"
/display/re-render


; --------------------------------------------------------------------------------------------
; Redefinition of fluid and solid phase
; --------------------------------------------------------------------------------------------

/define/phases/phase-domain fluid fluid y cross
/define/phases/phase-domain solid , n y n n n constant (%rpgetvar 'sand/d) gidaspow lun-et-al schaeffer constant (%rpgetvar 'sand/angle_intfric) johnson-et-al derived constant (%rpgetvar 'sand/alpha_fric) algebraic lun-et-al lun-et-al derived constant (%rpgetvar 'sand/alpha_pack)
/define/phases/interaction-domain n n y gidaspow y constant 1 n y 0.9 0 n n n 


; --------------------------------------------------------------------------------------------
; Initialization (Read interpolated steady-state data and patch zeros in rest of domain)
; The results of the presimulations (settling of granular column) doe not feature a homogeneous
; profile of frictional viscositites leading to an immediate collapse of the cliff
; --------------------------------------------------------------------------------------------

;/file/interpolate/read-data "patch_9.ip"

; Patch zeros to RHS of cliff to set width of cliff
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min2) (%rpgetvar 'x_max) 0 (%rpgetvar 'y_max1)
;/solve/patch solid , , , mp 0.0
;/solve/patch solid , , , x-velocity , 0.0
;/solve/patch solid , , , y-velocity , 0.0
;/solve/patch solid , , , granular-temperature 0.0

; Patch zeros to top of cliff to reduce aspect ratio
;/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) (%rpgetvar 'y_max2) (%rpgetvar 'y_max1)
;/solve/patch solid , 1 () mp 0
;/solve/patch solid , 1 () x-velocity , 0.0
;/solve/patch solid , 1 () y-velocity , 0.0
;/solve/patch solid , 1 () granular-temperature 0.0

; Export initial cliff
;/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n,
;/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Initialization (Initialize to zeros and patch solid vof according to initial cliff dimensions)
; --------------------------------------------------------------------------------------------

; Initialize entire domain
/solve/initialize/set-defaults/fluid x-velocity 0
/solve/initialize/set-defaults/fluid y-velocity 0
/solve/initialize/set-defaults/solid x-velocity 0
/solve/initialize/set-defaults/solid y-velocity 0
/solve/initialize/set-defaults/solid mp 0
/solve/initialize/set-defaults/solid granular-temperature 0
/solve/initialize/initialize-flow ,

; Patch solid volume fraction
/adapt/mark-inout-rectangle/ y n (%rpgetvar 'x_min1) (%rpgetvar 'x_min2) 0 (%rpgetvar 'y_max2)
/solve/patch solid , , , mp (%rpgetvar 'sand/alpha_ini)
/solve/patch solid , , , granular-temperature 1e-9

; Export initial cliff
/file/export/ascii "solution/exports/vof_init_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_init_cc.txt" interior-mixture () , solid-vof () n


; --------------------------------------------------------------------------------------------
; Adaptive mesh refinement
; --------------------------------------------------------------------------------------------

/adapt/set/min-number-cells 100
/adapt/set/max-number-cells 100000
/adapt/set/min-cell-volume 1e-7
/adapt/set/max-level-refine 3
/adapt/set/coarsen-mesh? y
/adapt/set/refine-mesh? y
/adapt/adapt-to-gradients/solid/vof space-gradient 2 n 0.7 0.3 y 5


; --------------------------------------------------------------------------------------------
; Monitors
; --------------------------------------------------------------------------------------------

/display/set-window 2
/solve/monitors/volume/set-monitor solid-velocity "Volume-Average" solid velocity-magnitude mixture () y 2 n y "solution/monitors/sol-vel.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-frict-visc "Volume-Average" solid frictional-viscosity mixture () y 2 n y "solution/monitors/sol-fric-visc.txt" 1 y flow-time
/solve/monitors/volume/set-monitor solid-gran-pres "Volume-Average" solid granular-pressure mixture () y 2 n y "solution/monitors/sol-gran-pres.txt" 1 y flow-time

; Set log scale via recorded journal file because apparently no TUI command for monitor plots
; Removed because incompatible with hpc

/display/set-window 3
/solve/monitors/volume/set-monitor solid-vol-frac "Max" solid vof mixture () y 3 n y "solution/monitors/sol-vol-frac.txt" 1 y flow-time


; --------------------------------------------------------------------------------------------
; Autosave
; --------------------------------------------------------------------------------------------

/file/auto-save/data-frequency 10000
/file/auto-save/append-file-name-with time-step 6
/file/auto-save/root-name "solution/casefiles/case"


; --------------------------------------------------------------------------------------------
; CFD post data export
; --------------------------------------------------------------------------------------------

/file/transient-export/delete cfd-post
/file/export/cfd-post-compatible solution/cfd-post/case-0.000000 , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q y ,
/file/transient-export/cfd-post-compatible solution/cfd-post/case , , solid-vof solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-frictional-viscosity q , n cfd-post 100 flow-time 6
; Other quantities to write to cfd-post files:
; fluid-velocity-magnitude solid-velocity-magnitude solid-x-velocity solid-y-velocity solid-granular-pressure solid-frictional-viscosity solid-granular-temperature solid-dynamic-pressure solid-viscosity-lam solid-total-pressure


; --------------------------------------------------------------------------------------------
; Execute Commands (Display results during computations)
; --------------------------------------------------------------------------------------------

/solve/execute-commands/add-edit command-1 1 "time-step" "/display/set-window 4"
/solve/execute-commands/add-edit command-2 1 "time-step" "/display/contour solid vof , ,"
/solve/execute-commands/add-edit command-3 1 "time-step" "/display/set/contours/filled-contours n"
/solve/execute-commands/add-edit command-4 1 "time-step" "/display/re-render"
/solve/execute-commands/add-edit command-5 1 "time-step" "/display/set/overlays y"
/solve/execute-commands/add-edit command-6 1 "time-step" "/display/vector solid velocity solid velocity-magnitude , , , ,"

/display/set-window 4
/display/contour solid vof , ,
/display/set/contours/filled-contours n
/display/re-render
/display/set/overlays y
/display/vector solid velocity solid velocity-magnitude , , , ,


; --------------------------------------------------------------------------------------------
; Solve
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-0.cas" OK
/define/user-defined/compiled-functions load "libudf"

/solve/set/time-step 1e-3
/solve/dual-time-iterate 60000 40 n OK n OK n OK n OK


; --------------------------------------------------------------------------------------------
; Write to file
; --------------------------------------------------------------------------------------------

/define/user-defined/compiled-functions unload "libudf"
/file/write-case-data "solution/casefiles/case-solved.cas" OK
/file/export/ascii "solution/exports/vof_final_nv.txt" interior-mixture () , solid-vof () n
/file/export/ascii "solution/exports/vof_final_cc.txt" interior-mixture () , solid-vof () n
/report/summary y "solution/reports/casesetup.txt"
/solve/monitors/volume/clear-monitors

!mkdir "solutions/a=3/alpha_s=0.55/pac4/9"
!robocopy /S libudf solution/casefiles/libudf
!robocopy /S solution solutions/a=3/alpha_s=0.55/pac4/9



